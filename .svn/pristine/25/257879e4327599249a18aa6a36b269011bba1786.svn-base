<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.example.demo.mapper.AjaxMapper">

  <!-- 리스트 View -->
  <select id="selectListAll" resultType="com.example.demo.dto.AjaxDto">
		SELECT * 
		FROM (SELECT ROWNUM rnum, 
					 a.* 
			  FROM(SELECT user_id,
				          title_ajax,
				          contents_ajax,
				          date_ajax,
				          postNum_ajax,
				          groupNum_ajax,
				          indentNum_ajax,
				          stepNum_ajax,
				          hitNum_ajax
					FROM hu_ajax
					
		<if test='search != null and category.equals("total")'>
					WHERE title_ajax LIKE '%'||#{search}||'%' 
					OR contents_ajax LIKE '%'||#{search}||'%'
		</if>
		<if test='search != null and category.equals("title")'>
					WHERE title_ajax LIKE '%'||#{search}||'%' 
		</if>
		<if test='search != null and category.equals("content")'>
					WHERE contents_ajax LIKE '%'||#{search}||'%'
		</if>
					
					ORDER BY groupNum_ajax DESC, stepNum_ajax ASC) a)
					WHERE rnum >= #{startRow} 
					AND rnum &lt;= #{endRow}
  </select>
  
  
  <!-- 페이지 넘버링 - 총 게시물 개수 확인 -->
  <select id="listCount" resultType="int">
		SELECT Count(*) 
		FROM hu_ajax
		
		<if test='search != null and category.equals("total")'>
			WHERE title_ajax LIKE '%'||#{search}||'%' 
			OR contents_ajax LIKE '%'||#{search}||'%'
		</if>
		<if test='search != null and category.equals("title")'>
			WHERE title_ajax LIKE '%'||#{search}||'%' 
		</if>
		<if test='search != null and category.equals("content")'>
			WHERE contents_ajax LIKE '%'||#{search}||'%'
		</if>
  
  </select>
  
  <!-- 글쓰기 -->
   <insert id="insertWrite">
		INSERT INTO hu_ajax(user_id,
							title_ajax,
							contents_ajax,
							date_ajax,
							postNum_ajax,
							groupNum_ajax,
							indentNum_ajax,
							stepNum_ajax,
							hitNum_ajax) 
					VALUES (#{user_id},
						   #{title_ajax},
						   #{contents_ajax},
						   sysdate,
						   ajax_seq.nextval,
						   ajax_seq.currval,
						   0,
						   0,
						   0)
  </insert>
  
  

  <!-- 상세 페이지 -->
  <select id="selectView" resultType="com.example.demo.dto.AjaxDto">
		SELECT user_id,
		       title_ajax,
		       contents_ajax,
		       date_ajax,
		       postNum_ajax,
		       groupNum_ajax,
		       indentNum_ajax,
		       stepNum_ajax,
		       hitNum_ajax
		FROM hu_ajax
		WHERE postNum_ajax=#{postNum_ajax}
  </select>
  

  <!-- 조회수 1 증가 처리 -->
  <update id="updateHitNum">
		UPDATE hu_ajax 
		SET hitNum_ajax = hitNum_ajax+1 
		WHERE postNum_ajax = #{postNum_ajax}
  </update>
  
  
  <!-- 글 삭제하기 -->
  <delete id="deleteView">
		DELETE FROM hu_ajax
		WHERE postNum_ajax=#{postNum_ajax}
  </delete> 
  
  
  <!-- 글 수정하기 -->
  <update id="updateModify">
		UPDATE hu_ajax 
		SET title_ajax=#{title_ajax}, 
			contents_ajax=#{contents_ajax}
		WHERE postNum_ajax=#{postNum_ajax}
  </update>
  
  
  
  <!-- 답변하기 저장 -->
  <insert id="insertReply">
		INSERT INTO hu_ajax(user_id,
							title_ajax,
							contents_ajax,
							date_ajax,
							postNum_ajax,
							groupNum_ajax,
							indentNum_ajax,
							stepNum_ajax,
							hitNum_ajax) 
					VALUES (#{user_id},
						   #{title_ajax},
						   #{contents_ajax},
						   sysdate,
						   ajax_seq.nextval,
						   #{groupNum_ajax},
						   #{indentNum_ajax}+1,
						   #{stepNum_ajax}+1,
						   0)
  </insert>
  
  
  <!-- 답변하기 - 현재 댓글 아래 stepNum+1 처리 -->
  <update id="updateReplyPlus">
		UPDATE hu_ajax 
		SET stepNum_ajax=stepNum_ajax+1
		WHERE groupNum_ajax=#{groupNum_ajax} 
			  AND stepNum_ajax > #{stepNum_ajax}
  </update>
  

  <!-- 입력된 답변내용 불러오기 -->
  <select id="selectReplyView" resultType="com.example.demo.dto.AjaxDto">
		SELECT user_id,
			   title_ajax, 
			   contents_ajax, 
			   date_ajax, 
			   postNum_ajax, 
			   groupNum_ajax, 
			   indentNum_ajax, 
			   stepNum_ajax, 
			   hitNum_ajax
		FROM hu_ajax
		WHERE groupNum_ajax=#{groupNum_ajax} 
			  AND date_ajax= (SELECT Max(date_ajax) 
			  				  FROM hu_ajax
							  WHERE groupNum_ajax=#{groupNum_ajax})
  </select>

  
  



  
</mapper>
