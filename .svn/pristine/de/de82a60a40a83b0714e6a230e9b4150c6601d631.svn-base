<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.example.demo.mapper.BoardMapper">

  <!-- 리스트 View (검색 X)-->
  <select id="selectListAll" resultType="com.example.demo.dto.BoardDto">
		SELECT * 
		FROM (SELECT ROWNUM rnum, 
					 a.* 
			  FROM (SELECT postNum, 
			  			   user_id, 
			  			   title, 
			  			   contents, 
			  			   boardDate, 
			  			   fileName, 
			  			   groupNum, 
			  			   indentNum, 
			  			   hitNum, 
			  			   stepNum, 
			  			   (SELECT Count(*) 
			  			   FROM hu_reply r 
			  			   WHERE b.postNum = r.postNum) AS reCnt
					FROM hu_board b
					ORDER BY groupNum+0 DESC, stepNum+0 ASC) a)
		WHERE rnum >= #{startRow} 
		AND rnum &lt;= #{endRow}
		
  </select>
  
  
  <!-- 리스트 View (검색, 전체)-->
  <select id="selectListAllSearchTotal" resultType="com.example.demo.dto.BoardDto">
		SELECT * 
		FROM (SELECT ROWNUM rnum, 
					 a.* 
			  FROM (SELECT postNum, 
			  			   user_id, 
			  			   title, 
			  			   contents, 
			  			   boardDate, 
			  			   fileName, 
			  			   groupNum, 
			  			   indentNum, 
			  			   hitNum, 
			  			   stepNum, 
			  			   (SELECT Count(*) 
			  			   FROM hu_reply r 
			  			   WHERE b.postNum = r.postNum) AS reCnt
					FROM hu_board b
					WHERE title LIKE '%'||#{search}||'%' 
					OR contents LIKE '%'||#{search}||'%'
					ORDER BY groupNum+0 DESC, stepNum+0 ASC) a)
		WHERE rnum >= #{startRow} 
		AND rnum &lt;= #{endRow}
		
  </select>  
  
  
  
  <!-- 리스트 View (검색, 제목)-->
  <select id="selectListAllSearchTitle" resultType="com.example.demo.dto.BoardDto">
		SELECT * 
		FROM (SELECT ROWNUM rnum, 
					 a.* 
			  FROM (SELECT postNum, 
			  			   user_id, 
			  			   title, 
			  			   contents, 
			  			   boardDate, 
			  			   fileName, 
			  			   groupNum, 
			  			   indentNum, 
			  			   hitNum, 
			  			   stepNum, 
			  			   (SELECT Count(*) 
			  			   FROM hu_reply r 
			  			   WHERE b.postNum = r.postNum) AS reCnt
					FROM hu_board b
					WHERE title LIKE '%'||#{search}||'%' 
					ORDER BY groupNum+0 DESC, stepNum+0 ASC) a)
		WHERE rnum >= #{startRow} 
		AND rnum &lt;= #{endRow}
		
  </select>
  
  
  
    <!-- 리스트 View (검색, 내용)-->
  <select id="selectListAllSearchContent" resultType="com.example.demo.dto.BoardDto">
		SELECT * 
		FROM (SELECT ROWNUM rnum, 
					 a.* 
			  FROM (SELECT postNum, 
			  			   user_id, 
			  			   title, 
			  			   contents, 
			  			   boardDate, 
			  			   fileName, 
			  			   groupNum, 
			  			   indentNum, 
			  			   hitNum, 
			  			   stepNum, 
			  			   (SELECT Count(*) 
			  			   FROM hu_reply r 
			  			   WHERE b.postNum = r.postNum) AS reCnt
					FROM hu_board b
					WHERE contents LIKE '%'||#{search}||'%' 
					ORDER BY groupNum+0 DESC, stepNum+0 ASC) a)
		WHERE rnum >= #{startRow} 
		AND rnum &lt;= #{endRow}
		
  </select>
  
  
  
  
  


  <!-- 글쓰기 저장 -->
  <insert id="insertWrite">
		INSERT INTO hu_board
		            (postnum,
		             user_id,
		             title,
		             contents,
		             boarddate,
		             filename,
		             groupnum,
		             indentnum,
		             hitnum,
		             stepnum)
		VALUES     ( board_seq.nextval,
		             #{user_id},
		             #{title},
		             #{contents},
		             sysdate,
		             #{fileName},
		             board_seq.currval,
		             '0',
		             '0',
		             '0')   
  </insert>
  
  
  <!-- 페이지 넘버링 - 총 개시글 개수 확인(검색 X) -->
  <select id="listCount" resultType="int">
		SELECT Count(*) 
		FROM hu_board
  </select>
  
  
  
  <!-- 페이지 넘버링 - 총 개시글 개수 확인(검색 O - 전체검색) -->
  <select id="listCountSearchTotal" resultType="int">
		SELECT count(*) 
		FROM hu_board
		WHERE title LIKE '%'||#{search}||'%' 
		OR contents LIKE '%'||#{search}||'%'
  </select>  
  
  
  <!-- 페이지 넘버링 - 총 개시글 개수 확인(검색 O - 제목검색) -->
  <select id="listCountSearchTitle" resultType="int">
		SELECT count(*) 
		FROM hu_board
		WHERE title LIKE '%'||#{search}||'%' 
  </select>
  

  <!-- 페이지 넘버링 - 총 개시글 개수 확인(검색 O - 내용검색) -->
  <select id="listCountSearchContent" resultType="int">
		SELECT count(*) 
		FROM hu_board
		WHERE contents LIKE '%'||#{search}||'%'
  </select>
  
  
  
  
  
  
  
  
  
  
  
  <!-- 상세페이지 --> 
  <select id="selectView" resultType="com.example.demo.dto.BoardDto">
		SELECT postnum, 
			   user_id, 
			   title, 
			   contents, 
			   boarddate, 
			   filename, 
			   groupnum, 
			   indentnum, 
			   hitnum, 
			   stepnum
		FROM hu_board
		WHERE postNum=#{postNum}
  </select>
  
  
  <!-- 조회수 1 증가 처리 -->
  <insert id="updateHitNum">
		UPDATE hu_board 
		SET hitNum = hitNum+1 
		WHERE postNum = #{postNum}
  </insert>
  
  
  <!-- 상세페이지 내 - 이전글 가져오기 --> 
  <select id="selectPreDto" resultType="com.example.demo.dto.BoardDto">
SELECT * 
FROM (
		SELECT rownum rnum, 
			   a.* 
		FROM (
				SELECT * 
				FROM hu_board 
				ORDER BY groupNum+0 DESC, 
						 stepNum+0 ASC) a)
WHERE rnum=
			(
				SELECT rnum 
				FROM (
						SELECT rownum rnum, 
							   a.* 
						FROM (
								SELECT * 
								FROM hu_board 
								ORDER BY groupNum+0 DESC, 
										 stepNum+0 ASC) a)
				WHERE postNum=${postNum}) +1
  </select>
  
  
  <!-- 상세페이지 내 - 다음글 가져오기 --> 
  <select id="selectNextDto" resultType="com.example.demo.dto.BoardDto">
SELECT * 
FROM (
		SELECT rownum rnum, 
			   a.* 
		FROM (
				SELECT * 
				FROM hu_board 
				ORDER BY groupNum+0 DESC, 
						 stepNum+0 ASC) a)
WHERE rnum=
			(
				SELECT rnum 
				FROM (
						SELECT rownum rnum, 
							   a.* 
						FROM (
								SELECT * 
								FROM hu_board 
								ORDER BY groupNum+0 DESC, 
										 stepNum+0 ASC) a)
				WHERE postNum=${postNum}) -1
  </select>
  
  
  <!-- 수정하기 - View 페이지 --> 
  <select id="selectModifyView" resultType="com.example.demo.dto.BoardDto">
		SELECT postnum, 
			   user_id, 
			   title, 
			   contents, 
			   boarddate, 
			   filename, 
			   groupnum, 
			   indentnum, 
			   hitnum, 
			   stepnum
		FROM hu_board
		WHERE postNum=#{postNum}
  </select>
  
  
  
  <!-- 수정하기 - DB 저장 -->
  <update id="updateModify">
		UPDATE hu_board 
		SET title=#{title}, 
			contents=#{contents}, 
			boardDate=sysdate,
			fileName=#{fileName}
		WHERE postNum=#{postNum}
  </update>
  
  
  
  
  <!-- 삭제하기 -->
  <delete id="deleteChk">
		DELETE FROM hu_board
		WHERE postNum=#{postNum}
  </delete>  
  
  
  
  <!-- 답변하기 - View 페이지 --> 
  <select id="selectReplyView" resultType="com.example.demo.dto.BoardDto">
		SELECT postNum, 
			   user_id, 
			   title, 
			   contents, 
			   boardDate, 
			   fileName, 
			   groupNum, 
			   indentNum, 
			   hitNum, 
			   stepNum
		FROM hu_board
		WHERE postNum=#{postNum}
  </select> 



  <!-- 답변하기 저장 -->
  <insert id="insertReply">
		INSERT INTO hu_board
		            (postNum,
		             user_id,
		             title,
		             contents,
		             boardDate,
		             fileName,
		             groupNum,
		             indentNum,
		             hitNum,
		             stepNum)
		VALUES     ( board_seq.nextval,
		             #{user_id},
		             #{title},
		             #{contents},
		             sysdate,
		             #{fileName},
		             #{groupNum},
		             #{indentNum}+1,
		             '0',
		             #{stepNum}+1)   
  </insert>


  <!-- 답변하기 - 현재 댓글 아래 stepNum+1 처리 -->
  <update id="updateReplyPlus">
		UPDATE hu_board 
		SET stepNum=#{stepNum}+1
		WHERE groupNum=#{groupNum} 
			  AND stepNum+0 > #{stepNum}
  </update>



  <!-- 댓글 리스트 View -->
  <select id="selectReplyAll" resultType="com.example.demo.dto.ReplyDto">
		SELECT reNum, 
			   user_id, 
			   reContents, 
			   reDate, 
			   reGroupNum, 
			   reIndentNum, 
			   reStepNum, 
			   reSecret, 
			   postNum 
		FROM hu_reply 
		WHERE postNum=#{postNum}
		ORDER BY reDate ASC
  </select>
  
  
  
  
   <!-- 댓글 저장 -->
   <insert id="insertReplyWrite">
		INSERT INTO hu_reply
		            (reNum, 
			   		 user_id, 
			   		 reContents, 
			   		 reDate, 
			   		 reGroupNum, 
			   		 reIndentNum, 
			   		 reStepNum, 
			   		 reSecret, 
			   		 postNum)
		VALUES     (reply_seq.nextval,
					#{user_id},
					#{reContents},
					sysdate,
					reply_seq.currval,
					'0', 
					'0', 
					#{reSecret}, 
					#{postNum})   
  </insert>




  <!-- 댓글 수정 - DB 저장하기 -->
  <update id="updateReplyModify">
		UPDATE hu_reply 
		SET reContents=#{reContents}, 
			reSecret=#{reSecret}
		WHERE postNum=#{postNum} 
			  AND reNum =#{reNum}
  </update>
  
  
  
  <!-- 댓글 삭제 -->
  <delete id="deleteReply">
		DELETE FROM hu_reply
		WHERE postNum=#{postNum} 
			  AND reNum=#{reNum}
  </delete>  
  
  
  <!-- 엑셀 다운로드 용 - 리스트 출력 -->
  <select id="selectListAllForExcelDown" resultType="com.example.demo.dto.BoardDto">
		SELECT * 
		FROM (SELECT ROWNUM rnum, 
					 a.* 
			  FROM (SELECT postNum, 
			  			   user_id, 
			  			   title, 
			  			   contents, 
			  			   boardDate, 
			  			   fileName, 
			  			   groupNum, 
			  			   indentNum, 
			  			   hitNum, 
			  			   stepNum, 
			  			   (SELECT Count(*) 
			  			   FROM hu_reply r 
			  			   WHERE b.postNum = r.postNum) AS reCnt
					FROM hu_board b
					ORDER BY groupNum+0 DESC, stepNum+0 ASC) a)
		
  </select>


  
</mapper>
